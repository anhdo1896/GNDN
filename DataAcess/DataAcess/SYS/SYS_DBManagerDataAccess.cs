//------------------------------------------------------------------------------------------------------------------------
//-- Generated By:   TrungVK using CodeSmith 5.0.0.0
//-- Template:       DataAcess.cst
//-- Date Generated: Monday, July 12, 2010
//------------------------------------------------------------------------------------------------------------------------
using System;
using System.Collections.Generic;
using System.Data.Common;
using System.Linq;
using System.Text;
using Connection;
using System.Data.SqlClient;

namespace DataAccess
{
    public class SYS_DBManagerDataAccess 
    {
           private MSSqlHelper _DbHelper = new MSSqlHelper();
        public bool BackupDB(string fileName)
        {
            bool result;
            try
            {
                if (_DbHelper.RunQuery(new SqlConnection(Common.ConnectionString), "BACKUP DATABASE " + GetDBName() + " TO DISK = '" + fileName + "'"))
                {
                    result = true;
                }
                else
                {
                    result = false;
                }
                
            }
            catch (Exception ex)
            {
                return false;
            }
            return result;
        }
        public bool RestoreDB(string fileName)
        {
            bool result;
            try
            {
                string dbName = GetDBName();
                string conectionstringmaster = GetConectionStringMaster();
                DbConnection connection = Common.CreateConnection(conectionstringmaster);
                if (_DbHelper.RunQuery(connection, "EXEC sp_KillDatabaseUsers '" + dbName + "'"))
                {
                    if (_DbHelper.RunQuery(connection, "RESTORE DATABASE " + dbName + " FROM DISK ='" + fileName + "' WITH REPLACE"))
                    {
                        result = true;
                    }
                    else
                    {
                        result = false;
                    }
                }
                else
                {
                    result = false;
                }

            }
            catch (Exception ex)
            {
                return false;
            }
            return result;
        }

        private string GetDBName()
        {
            //@"Data Source=192.168.1.199\sql2005;Initial Catalog=SSV;Persist Security Info=True;User ID=sa;Password=SSV1"
            string dbName = "";
            string[] arrString = Common.ConnectionString.Split(';');
            for (int i = 0; i < arrString.Length; i++)
            {
                if (arrString[i].IndexOf("Initial Catalog") > -1)
                {
                    dbName = arrString[i].Replace("Initial Catalog=", "");
                    break;
                }
            }
            return dbName;
        }

        private string GetConectionStringMaster()
        {
            //@"Data Source=192.168.1.199\sql2005;Initial Catalog=SSV;Persist Security Info=True;User ID=sa;Password=SSV1"
            string conectionStringMaster = "";
            string[] arrString = Common.ConnectionString.Split(';');
            for (int i = 0; i < arrString.Length; i++)
            {
                if (arrString[i].IndexOf("Initial Catalog") > -1)
                {
                    conectionStringMaster += "Initial Catalog=master;";
                }
                else
                {
                    conectionStringMaster += arrString[i] + ";";
                }
            }
            return conectionStringMaster.Substring(0,conectionStringMaster.Length -1);
        }
    }
}


